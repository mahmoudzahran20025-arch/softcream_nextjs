# ğŸ¦ Soft Cream - AI Development Rules & Context

**Last Updated:** November 19, 2025  
**Status:** Post-Cleanup - Production Ready  
**Codebase Health:** âœ… Clean & Optimized

---

## ğŸ“‹ Table of Contents

1. [Tech Stack & Environment](#1-tech-stack--environment)
2. [Architecture & Directory Structure](#2-architecture--directory-structure)
3. [Coding Standards (Must Follow)](#3-coding-standards-must-follow)
4. [Critical Rules (The "Do Nots")](#4-critical-rules-the-do-nots)
5. [Key Integration Files](#5-key-integration-files)
6. [API & Data Flow Patterns](#6-api--data-flow-patterns)
7. [State Management Strategy](#7-state-management-strategy)
8. [Styling & UI Guidelines](#8-styling--ui-guidelines)
9. [Performance & Optimization](#9-performance--optimization)
10. [Testing & Quality Assurance](#10-testing--quality-assurance)

---

## 1. Tech Stack & Environment

### Frontend (Next.js App)
- **Framework:** Next.js 16.0.3 (App Router)
- **React:** 18.3.1
- **Language:** TypeScript 5.3.3 (Strict Mode Enabled)
- **Styling:** Tailwind CSS 3.4.15
- **State Management:** 
  - React Context API (Primary)
  - Zustand 4.4.0 (Lightweight global state)
  - TanStack Query 5.28.0 (Server state)
- **Animations:** Framer Motion 12.23.24
- **Icons:** Lucide React 0.454.0
- **Carousel:** Swiper 11.1.14
- **Build Tool:** Next.js built-in (Turbopack in dev)

### Backend (Cloudflare Worker)
- **Runtime:** Cloudflare Workers (Edge Computing)
- **Language:** JavaScript (ES Modules)
- **Database:** Cloudflare D1 (SQLite)
- **Cache:** Cloudflare KV
- **Testing:** Vitest 3.2.0
- **Deployment:** Wrangler 4.43.0

### Key Environment Variables
```env
# Frontend (.env.local)
NEXT_PUBLIC_API_URL=https://softcream-api.mahmoud-zahran20025.workers.dev

# Backend (wrangler.toml)
TELEGRAM_BOT_TOKEN=<secret>
TELEGRAM_CHAT_ID=-1002896286203
ADMIN_TOKEN=<secret>
```

### TypeScript Configuration
- **Strict Mode:** âœ… Enabled
- **No Unused Locals:** âœ… Enabled
- **No Unused Parameters:** âœ… Enabled
- **Module Resolution:** Bundler
- **Path Aliases:** `@/*` â†’ `./src/*`

---

## 2. Architecture & Directory Structure

### Frontend Structure (Next.js App Router)

```
soft-cream-nextjs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Next.js App Router (Pages)
â”‚   â”‚   â”œâ”€â”€ layout.tsx          # Root layout (RTL, Cairo font)
â”‚   â”‚   â”œâ”€â”€ page.tsx            # Home page (SSR with ISR)
â”‚   â”‚   â”œâ”€â”€ admin/              # Admin dashboard
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx        # Client-side admin app
â”‚   â”‚   â”œâ”€â”€ globals.css         # Global styles + Tailwind
â”‚   â”‚   â”œâ”€â”€ error.tsx           # Error boundary
â”‚   â”‚   â”œâ”€â”€ loading.tsx         # Loading UI
â”‚   â”‚   â””â”€â”€ not-found.tsx       # 404 page
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # React Components (Feature-based)
â”‚   â”‚   â”œâ”€â”€ admin/              # Admin dashboard components
â”‚   â”‚   â”œâ”€â”€ modals/             # Modal components (Cart, Checkout, etc.)
â”‚   â”‚   â”œâ”€â”€ pages/              # Page-specific components
â”‚   â”‚   â”œâ”€â”€ server/             # Server Components (Footer, etc.)
â”‚   â”‚   â”œâ”€â”€ ui/                 # Reusable UI components
â”‚   â”‚   â””â”€â”€ StorytellingHero/   # Hero section (modular)
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/              # React Context Providers
â”‚   â”‚   â”œâ”€â”€ Providers.tsx       # Root provider wrapper
â”‚   â”‚   â”œâ”€â”€ CartProvider.tsx    # Cart state management
â”‚   â”‚   â”œâ”€â”€ ProductsProvider.tsx # Products filtering
â”‚   â”‚   â””â”€â”€ ThemeProvider.tsx   # Dark mode + i18n
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                    # Core utilities & API clients
â”‚   â”‚   â”œâ”€â”€ api.ts              # Frontend API client (server-safe)
â”‚   â”‚   â”œâ”€â”€ adminApi.ts         # Admin API client
â”‚   â”‚   â”œâ”€â”€ orderPoller.ts      # Real-time order polling
â”‚   â”‚   â”œâ”€â”€ orderTracking.ts    # Order tracking logic
â”‚   â”‚   â”œâ”€â”€ storage.client.ts   # Client-side storage manager
â”‚   â”‚   â”œâ”€â”€ queryClient.ts      # TanStack Query config
â”‚   â”‚   â””â”€â”€ utils.ts            # Helper functions
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                  # Custom React Hooks
â”‚   â”‚   â”œâ”€â”€ useApiClient.ts     # API request hook
â”‚   â”‚   â”œâ”€â”€ useHydrated.ts      # SSR hydration check
â”‚   â”‚   â””â”€â”€ useOrderStatusSSE.ts # Order status updates
â”‚   â”‚
â”‚   â”œâ”€â”€ data/                   # Static data & translations
â”‚   â”‚   â”œâ”€â”€ translations-data.ts # i18n strings
â”‚   â”‚   â””â”€â”€ translations-data-additions.ts
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # Utility functions
â”‚       â””â”€â”€ batch-dom.ts        # DOM batch operations
â”‚
â”œâ”€â”€ public/                     # Static assets
â”œâ”€â”€ docs/                       # Documentation
â”‚   â”œâ”€â”€ archive/                # Archived docs (34 files)
â”‚   â””â”€â”€ CLEANUP_NEXT_STEPS.md   # Cleanup guide
â”‚
â”œâ”€â”€ tailwind.config.ts          # Tailwind configuration
â”œâ”€â”€ tsconfig.json               # TypeScript configuration
â”œâ”€â”€ next.config.js              # Next.js configuration
â””â”€â”€ package.json                # Dependencies
```

### Backend Structure (Cloudflare Worker)

```
softcream-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                # Main worker entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                 # API route handlers
â”‚   â”‚   â”œâ”€â”€ products.js         # Product endpoints
â”‚   â”‚   â”œâ”€â”€ orders.js           # Order endpoints
â”‚   â”‚   â”œâ”€â”€ branches.js         # Branch endpoints
â”‚   â”‚   â”œâ”€â”€ coupons.js          # Coupon system (NEW)
â”‚   â”‚   â”œâ”€â”€ admin.js            # Admin endpoints
â”‚   â”‚   â”œâ”€â”€ analytics.js        # Analytics tracking
â”‚   â”‚   â”œâ”€â”€ users.js            # User management
â”‚   â”‚   â””â”€â”€ migration.js        # Database migrations
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # Business logic layer
â”‚   â”‚   â”œâ”€â”€ productService.js   # Product operations
â”‚   â”‚   â”œâ”€â”€ orderService.js     # Order processing
â”‚   â”‚   â”œâ”€â”€ branchService.js    # Branch management
â”‚   â”‚   â”œâ”€â”€ couponService.js    # Coupon validation
â”‚   â”‚   â”œâ”€â”€ deliveryService.js  # Smart delivery pricing
â”‚   â”‚   â”œâ”€â”€ telegramService.js  # Telegram notifications
â”‚   â”‚   â”œâ”€â”€ orderTrackingService.js # Order tracking
â”‚   â”‚   â””â”€â”€ getOrderService.js  # Order retrieval
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/             # Request middleware
â”‚   â”‚   â”œâ”€â”€ auth.js             # Authentication
â”‚   â”‚   â”œâ”€â”€ errorHandler.js     # Global error handling
â”‚   â”‚   â””â”€â”€ rateLimit.js        # Rate limiting
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                 # Configuration
â”‚   â”‚   â”œâ”€â”€ constants.js        # Business rules & config
â”‚   â”‚   â””â”€â”€ cors.js             # CORS configuration
â”‚   â”‚
â”‚   â”œâ”€â”€ cache/                  # Caching layer
â”‚   â”‚   â”œâ”€â”€ cacheManager.js     # KV cache operations
â”‚   â”‚   â””â”€â”€ invalidation.js     # Cache invalidation
â”‚   â”‚
â”‚   â”œâ”€â”€ database/               # Database layer
â”‚   â”‚   â”œâ”€â”€ init.js             # Schema initialization
â”‚   â”‚   â””â”€â”€ seed.js             # Seed data
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # Utility functions
â”‚       â”œâ”€â”€ helpers.js          # Helper functions
â”‚       â””â”€â”€ response.js         # Response formatters
â”‚
â”œâ”€â”€ migrations/                 # SQL migrations
â”œâ”€â”€ test/                       # Vitest tests
â”œâ”€â”€ wrangler.toml               # Cloudflare config
â””â”€â”€ package.json                # Dependencies
```

### Architectural Patterns

1. **Frontend:** Feature-based component organization
2. **Backend:** Layered architecture (Routes â†’ Services â†’ Database)
3. **Data Flow:** Unidirectional (Server â†’ Context â†’ Components)
4. **API Communication:** RESTful with query params routing
5. **State Management:** Context for UI, TanStack Query for server state

---

## 3. Coding Standards (Must Follow)

### TypeScript Standards

#### Component Definitions
```typescript
// âœ… CORRECT: Default export functional component
export default function ComponentName({ prop }: Props) {
  return <div>...</div>
}

// âœ… CORRECT: Named export for utilities
export function helperFunction() { }

// âŒ WRONG: Arrow function default exports
export default () => <div>...</div>
```

#### Type Definitions
```typescript
// âœ… CORRECT: Interface for component props
interface ProductCardProps {
  product: Product
  onAddToCart?: (product: Product, quantity: number) => void
}

// âœ… CORRECT: Type for API responses
export type ApiResponse<T> = {
  data?: T
  success?: boolean
  error?: string
}

// âœ… NEW: Addon Types
interface Addon {
  id: string
  name: string
  name_en: string
  type: string
  price: number
  available: boolean
}

interface CartItem {
  productId: string
  quantity: number
  selectedAddons?: string[]  // Array of addon IDs
}

interface Product {
  id: string
  name: string
  price: number
  // ... other fields ...
  addonsList?: Addon[]  // Populated when expand=addons
  allowed_addons?: string  // JSON string of allowed addon IDs
}

// âš ï¸ PREFER: Interfaces over Types (unless union/intersection needed)
```

#### Strict Type Safety
```typescript
// âœ… CORRECT: Explicit return types for functions
export async function getProducts(): Promise<Product[]> {
  return httpRequest<Product[]>('GET', '/products')
}

// âœ… CORRECT: Type guards for runtime checks
if (typeof window !== 'undefined') {
  // Client-side only code
}

// âŒ WRONG: Using 'any' type
const data: any = await fetch() // âŒ Never use 'any'
```

### React Patterns

#### Client vs Server Components
```typescript
// âœ… Server Component (default in App Router)
// No 'use client' directive
export default async function ServerComponent() {
  const data = await fetchData() // Direct async/await
  return <div>{data}</div>
}

// âœ… Client Component (interactive)
'use client'
export default function ClientComponent() {
  const [state, setState] = useState()
  return <button onClick={() => setState()}>Click</button>
}
```

#### State Management
```typescript
// âœ… CORRECT: Context for shared UI state
const { cart, addToCart } = useCart()

// âœ… CORRECT: TanStack Query for server data
const { data, isLoading } = useQuery({
  queryKey: ['products'],
  queryFn: getProducts
})

// âœ… CORRECT: Local state for component-specific data
const [quantity, setQuantity] = useState(1)
```

#### Event Handlers
```typescript
// âœ… CORRECT: Inline arrow functions for simple handlers
<button onClick={() => setCount(count + 1)}>

// âœ… CORRECT: Named functions for complex logic
const handleAddToCart = useCallback((product: Product) => {
  // Complex logic here
}, [dependencies])

// âŒ WRONG: Creating new functions on every render
<button onClick={function() { /* ... */ }}>
```

### Styling Standards

#### Tailwind CSS Usage
```typescript
// âœ… CORRECT: Mobile-first responsive classes
<div className="w-full md:w-1/2 lg:w-1/3">

// âœ… CORRECT: Dark mode support
<div className="bg-white dark:bg-slate-950">

// âœ… CORRECT: Semantic class grouping
<button className="
  px-4 py-2 
  bg-purple-600 hover:bg-purple-700 
  text-white font-semibold 
  rounded-lg transition-colors
">

// âŒ WRONG: Inline styles (avoid unless dynamic)
<div style={{ color: 'red' }}>
```

#### CSS Custom Properties
```css
/* âœ… CORRECT: Use Tailwind theme extensions */
@layer base {
  :root {
    --font-cairo: 'Cairo', sans-serif;
  }
}

/* âŒ WRONG: Hardcoded values */
.custom-class {
  color: #9333ea; /* Use Tailwind classes instead */
}
```

### API & Data Fetching

#### Frontend API Calls
```typescript
// âœ… CORRECT: Use centralized API client
import { getProducts, submitOrder } from '@/lib/api'

// âœ… CORRECT: Use expand parameter for heavy data
const products = await getProducts({ expand: ['ingredients', 'nutrition', 'addons'] })
const product = await getProduct(id, { expand: ['recommendations', 'addons'] })

// âœ… CORRECT: Never send prices from frontend (including addons)
const orderData = {
  items: [
    { 
      productId: '1', 
      quantity: 2,
      selectedAddons: ['addon-1', 'addon-2']  // âœ… Only addon IDs
    }
  ],
  customer: { name, phone }
}

// âŒ WRONG: Direct fetch calls
const response = await fetch('https://api...') // âŒ Use api.ts

// âŒ WRONG: Sending addon prices
const orderData = {
  items: [
    { 
      productId: '1', 
      quantity: 2,
      selectedAddons: [
        { id: 'addon-1', price: 5 }  // âŒ SECURITY RISK
      ]
    }
  ]
}
```

#### Backend Service Layer
```javascript
// âœ… CORRECT: Service functions are pure business logic
export async function calculateOrderPrices(items, coupon, env) {
  // 1. Validate inputs
  // 2. Fetch data from DB
  // 3. Apply business rules
  // 4. Return calculated result
}

// âœ… CORRECT: Routes delegate to services
export async function handleOrderRoutes(path, body, env) {
  if (path === '/orders/submit') {
    return jsonResponse(await submitOrder(body, env), 200)
  }
}
```

### Error Handling

```typescript
// âœ… CORRECT: Try-catch with specific error messages
try {
  const result = await apiCall()
} catch (error: any) {
  console.error('Failed to fetch data:', error)
  if (error.isTimeout) {
    // Handle timeout
  } else if (error.isNetworkError) {
    // Handle network error
  }
  throw error
}

// âœ… CORRECT: User-friendly error messages
return {
  valid: false,
  error: 'ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ§Ù„Ø­',
  errorEn: 'Invalid coupon code'
}
```

### Naming Conventions

```typescript
// âœ… Components: PascalCase
ProductCard.tsx
CheckoutModal.tsx

// âœ… Utilities: camelCase
calculateTotal.ts
formatCurrency.ts

// âœ… Constants: UPPER_SNAKE_CASE
const API_URL = '...'
const MAX_QUANTITY = 50

// âœ… Types/Interfaces: PascalCase
interface ProductCardProps { }
type ApiResponse<T> = { }

// âœ… Files: kebab-case or PascalCase (consistent per folder)
order-tracking.ts  // utilities
OrderTracking.tsx  // components
```

---

## 4. Critical Rules (The "Do Nots")

### ğŸš« Absolute Prohibitions

#### 1. Never Look in Archive Folders
```bash
# â›” FORBIDDEN: These contain dead/deprecated code
_ARCHIVE_2025/
docs/archive/

# âœ… ALLOWED: Active documentation
docs/CLEANUP_NEXT_STEPS.md
```

#### 2. Never Use Deprecated Functions
```javascript
// â›” REMOVED: These functions no longer exist
searchProducts()        // Use client-side filtering
discoverProducts()      // Use client-side filtering
getProductsByEnergyType() // Use client-side filtering
getProductsByCategory()   // Use client-side filtering

// â›” DISABLED: These services are not implemented
gamificationService.js  // Feature not yet developed
promotionService.js     // Replaced by couponService.js
loyaltyService.js       // Feature not yet developed
sseService.js           // Replaced by polling
```

#### 3. Never Send Prices from Frontend
```typescript
// â›” WRONG: Sending prices from frontend
const orderData = {
  items: [
    { productId: '1', quantity: 2, price: 25 } // âŒ SECURITY RISK
  ]
}

// âœ… CORRECT: Backend calculates all prices (including addons)
const orderData = {
  items: [
    { 
      productId: '1', 
      quantity: 2,
      selectedAddons: ['addon-1', 'addon-2']  // âœ… Only IDs, no prices
    }
  ]
}

// Backend will:
// 1. Fetch product price from database
// 2. Fetch addon prices from database
// 3. Validate addons are allowed for this product
// 4. Calculate total: (product.price + sum(addon.prices)) * quantity
```

#### 4. Never Bypass Rate Limiting
```typescript
// â›” WRONG: Rapid-fire requests
for (let i = 0; i < 100; i++) {
  await submitOrder() // âŒ Will be rate-limited
}

// âœ… CORRECT: Respect rate limits
// - 5 orders per 60 seconds
// - 20 tracking polls per 60 seconds
// - Use debouncing for user actions
```

#### 5. Never Hardcode Sensitive Data
```typescript
// â›” WRONG: Hardcoded secrets
const ADMIN_TOKEN = 'admin123' // âŒ Use env variables

// âœ… CORRECT: Environment variables
const ADMIN_TOKEN = process.env.ADMIN_TOKEN
```

### âš ï¸ Strong Recommendations

#### 1. Avoid Large Files
```typescript
// âš ï¸ AVOID: Files > 500 lines
// âœ… PREFER: Split into smaller modules
// Example: Split adminApi.ts into:
// - adminApi/orders.ts
// - adminApi/coupons.ts
// - adminApi/analytics.ts
```

#### 2. Avoid Prop Drilling
```typescript
// âš ï¸ AVOID: Passing props through 3+ levels
<Parent>
  <Child prop={value}>
    <GrandChild prop={value}>
      <GreatGrandChild prop={value} /> {/* âŒ Too deep */}
    </GrandChild>
  </Child>
</Parent>

// âœ… PREFER: Use Context or composition
const value = useContext(MyContext)
```

#### 3. Avoid Inline Styles
```typescript
// âš ï¸ AVOID: Inline styles (unless truly dynamic)
<div style={{ color: 'red', fontSize: '16px' }}>

// âœ… PREFER: Tailwind classes
<div className="text-red-500 text-base">
```

#### 4. Avoid Direct DOM Manipulation
```typescript
// âš ï¸ AVOID: Direct DOM access
document.getElementById('myElement').style.color = 'red'

// âœ… PREFER: React state and refs
const ref = useRef<HTMLDivElement>(null)
useEffect(() => {
  if (ref.current) {
    ref.current.style.color = 'red'
  }
}, [])
```

---

## 5. Key Integration Files

### Frontend Source of Truth Files

#### 1. `src/app/layout.tsx` - Root Layout
**Purpose:** Global app configuration, fonts, metadata  
**Critical Elements:**
- RTL direction (`dir="rtl"`)
- Cairo font loading
- Dark mode class support
- SEO metadata

#### 2. `src/providers/Providers.tsx` - Provider Hierarchy
**Purpose:** Wraps app with all context providers  
**Order (Important):**
1. QueryClientProvider (TanStack Query)
2. ThemeProvider (Dark mode + i18n)
3. CartProvider (Cart state)

#### 3. `src/lib/api.ts` - Frontend API Client
**Purpose:** All API communication  
**Critical Functions:**
- `httpRequest()` - Core HTTP handler
- `getOrCreateDeviceId()` - Device tracking
- `calculateOrderPrices()` - Price calculation
- `submitOrder()` - Order submission
- `validateCoupon()` - Coupon validation

#### 4. `src/lib/storage.client.ts` - Client Storage Manager
**Purpose:** Centralized localStorage/sessionStorage  
**Manages:**
- Cart persistence
- Order history
- User preferences
- Device ID

#### 5. `src/components/pages/PageContent.tsx` - Main Page Orchestrator
**Purpose:** Coordinates homepage components  
**Responsibilities:**
- ProductsProvider initialization
- Hero section rendering
- Products grid display
- Footer rendering

### Backend Source of Truth Files

#### 1. `src/index.js` - Worker Entry Point
**Purpose:** Main request router  
**Handles:**
- CORS preflight
- Database initialization
- Route delegation
- Error handling

#### 2. `src/config/constants.js` - Business Rules
**Purpose:** All configurable values  
**Contains:**
- Delivery pricing tiers
- Timing calculations
- Rate limits
- Cache TTLs
- Free delivery threshold

#### 3. `src/services/orderService.js` - Order Processing
**Purpose:** Core order business logic  
**Functions:**
- `calculateOrderPrices()` - Price calculation
- `submitOrder()` - Order creation
- `trackOrder()` - Order tracking
- `cancelOrder()` - Order cancellation
- `editOrder()` - Order modification

#### 4. `src/services/deliveryService.js` - Smart Delivery
**Purpose:** Distance-based pricing  
**Functions:**
- `haversineDistance()` - GPS distance calculation
- `findNearestBranch()` - Branch selection
- `getDeliveryTier()` - Tier determination
- `calculateEta()` - ETA calculation

#### 5. `src/services/couponService.js` - Coupon System
**Purpose:** Coupon validation and tracking  
**Functions:**
- `validateCoupon()` - Validation logic
- `recordCouponUsage()` - Usage tracking
- `createCoupon()` - Admin creation
- `getCouponStats()` - Analytics

---

## 6. API & Data Flow Patterns

### Smart Expansion Pattern (NEW)

The API now supports selective data loading via `?expand=` query parameter:

```typescript
// âœ… CORRECT: Request only needed data
const products = await getProducts({ 
  expand: ['ingredients', 'nutrition', 'addons'] 
})

const product = await getProduct(productId, { 
  expand: ['recommendations', 'addons', 'allergens'] 
})

// Available expansion fields:
// - ingredients: Product ingredients list
// - nutrition: Detailed nutrition facts
// - allergens: Allergen information
// - tags: Product tags (always lightweight)
// - recommendations: Similar products (single product only)
// - addons: Allowed addons for product (NEW)

// Backend parses JSON fields and fetches related data
// Frontend receives enriched product objects:
{
  id: '1',
  name: 'Product Name',
  price: 25,
  // ... base fields ...
  
  // Expanded fields (only if requested):
  ingredientsList: ['ingredient1', 'ingredient2'],  // if expand=ingredients
  nutritionData: { calories: 250, protein: 10 },    // if expand=nutrition
  addonsList: [                                      // if expand=addons
    { id: 'addon-1', name: 'Extra Topping', price: 5 }
  ]
}
```

### Request Flow (Frontend â†’ Backend)

```
User Action
    â†“
Component Event Handler
    â†“
API Client (lib/api.ts)
    â†“
HTTP Request (with device ID, idempotency key, expand params)
    â†“
Cloudflare Worker (src/index.js)
    â†“
Route Handler (src/routes/*.js)
    â†“
Service Layer (src/services/*.js)
    â†“
Smart Data Enrichment (if expand params present)
    â†“
Database/Cache (D1/KV)
    â†“
Response (JSON with enriched data)
    â†“
API Client (parse & validate)
    â†“
Component State Update
    â†“
UI Re-render
```

### API URL Pattern

```typescript
// Frontend constructs URL with query param routing
const url = `${API_URL}?path=${encodeURIComponent(endpoint)}`

// Example:
// https://softcream-api.workers.dev?path=/products
// https://softcream-api.workers.dev?path=/orders/submit
```

### Authentication Flow

```typescript
// Admin endpoints require Bearer token
headers: {
  'Authorization': `Bearer ${getAdminToken()}`
}

// Token stored in localStorage
localStorage.setItem('admin_token', token)
```

### Error Response Format

```typescript
// Standard error response
{
  success: false,
  error: 'Error message in Arabic',
  errorEn: 'Error message in English',
  details?: 'Additional context'
}
```

---

## 7. State Management Strategy

### Context Providers (UI State)

#### CartProvider (Enhanced with Add-ons)
```typescript
// Purpose: Shopping cart state with addon support
// Storage: sessionStorage
// Scope: Global (all pages)
// âœ… NEW: Cart items now include selectedAddons array

interface CartItem {
  productId: string
  quantity: number
  selectedAddons?: string[]  // Array of addon IDs (NEW)
}

// Cart Logic: Unique Item Signature
// Same product + different addons = DIFFERENT cart items
// Example:
// - Product A + [Addon 1, Addon 2] â†’ Cart Item 1
// - Product A + [Addon 3]          â†’ Cart Item 2
// - Product A + []                 â†’ Cart Item 3

const { cart, addToCart, removeFromCart, clearCart } = useCart()

// Adding to cart with addons
addToCart(product, quantity, ['addon-1', 'addon-2'])

// Removing from cart (must match addons)
removeFromCart(productId, ['addon-1', 'addon-2'])

// Calculating total with addons
getCartTotal(productsMap, addonsMap)
```

#### ProductsProvider
```typescript
// Purpose: Product filtering and selection
// Storage: Memory (per-page)
// Scope: Homepage only
const { filteredProducts, applyFilters, openProduct } = useProductsData()
```

#### ThemeProvider
```typescript
// Purpose: Dark mode + i18n
// Storage: localStorage
// Scope: Global (all pages)
const { theme, toggleTheme, language, t } = useGlobal()
```

### TanStack Query (Server State)

```typescript
// Purpose: Server data caching and synchronization
// Use for: API data that needs caching/refetching

// Example: Products list
const { data: products, isLoading } = useQuery({
  queryKey: ['products'],
  queryFn: getProducts,
  staleTime: 5 * 60 * 1000, // 5 minutes
})

// Example: Order tracking
const { data: order } = useQuery({
  queryKey: ['order', orderId],
  queryFn: () => trackOrder(orderId),
  refetchInterval: 5000, // Poll every 5 seconds
})
```

### Local Component State

```typescript
// Purpose: Component-specific UI state
// Use for: Form inputs, toggles, temporary data

const [quantity, setQuantity] = useState(1)
const [isOpen, setIsOpen] = useState(false)
const [searchQuery, setSearchQuery] = useState('')
```

### State Update Patterns

```typescript
// âœ… CORRECT: Immutable updates
setCart(prevCart => [...prevCart, newItem])

// âœ… CORRECT: Functional updates for derived state
setQuantity(prev => Math.max(1, prev - 1))

// âŒ WRONG: Direct mutation
cart.push(newItem) // âŒ Mutates state
setCart(cart)      // âŒ Same reference
```

---

## 8. Styling & UI Guidelines

### Tailwind Configuration

```typescript
// Theme extensions (tailwind.config.ts)
theme: {
  extend: {
    colors: {
      primary: { /* purple shades */ },
    },
    fontFamily: {
      cairo: ['var(--font-cairo)', 'sans-serif'],
    },
    animation: {
      'fade-in': 'fadeIn 0.5s ease-in-out',
      'slide-up': 'slideUp 0.5s ease-out',
    },
  },
}
```

### Responsive Design

```typescript
// Mobile-first approach
<div className="
  w-full           // Mobile: full width
  md:w-1/2         // Tablet: half width
  lg:w-1/3         // Desktop: third width
  xl:w-1/4         // Large: quarter width
">
```

### Dark Mode Support

```typescript
// Always provide dark mode variants
<div className="
  bg-white dark:bg-slate-950
  text-slate-900 dark:text-white
  border-slate-200 dark:border-slate-700
">
```

### RTL Support

```typescript
// Layout is RTL by default (Arabic)
<html lang="ar" dir="rtl">

// Use logical properties
className="ms-4"  // margin-inline-start (RTL-aware)
className="me-4"  // margin-inline-end (RTL-aware)
```

### Accessibility

```typescript
// Always include ARIA labels
<button aria-label="Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©">
  <ShoppingCart />
</button>

// Use semantic HTML
<nav>...</nav>
<main>...</main>
<footer>...</footer>
```

---

## 9. Performance & Optimization

### Image Optimization

```typescript
// âœ… CORRECT: Use Next.js Image component
import Image from 'next/image'
<Image 
  src={product.image} 
  alt={product.name}
  width={200}
  height={250}
  loading="lazy"
/>

// âš ï¸ ACCEPTABLE: Regular img with lazy loading
<img 
  src={product.image}
  alt={product.name}
  loading="lazy"
  width={200}
  height={250}
/>
```

### Code Splitting

```typescript
// âœ… CORRECT: Dynamic imports for heavy components
const AdminApp = dynamic(() => import('@/components/admin/AdminApp'), {
  ssr: false,
  loading: () => <LoadingSpinner />
})
```

### Memoization

```typescript
// âœ… CORRECT: Memoize expensive calculations
const productsMap = useMemo(() => {
  return products.reduce((map, product) => {
    map[product.id] = product
    return map
  }, {})
}, [products])

// âœ… CORRECT: Memoize callbacks
const handleAddToCart = useCallback((product) => {
  addToCart(product, quantity)
}, [addToCart, quantity])
```

### Debouncing & Throttling

```typescript
// âœ… CORRECT: Debounce search input
const debouncedSearch = useMemo(
  () => debounce((query) => applyFilters({ searchQuery: query }), 300),
  [applyFilters]
)
```

### Caching Strategy

```typescript
// Backend: KV cache with TTL
await env.CACHE.put(key, JSON.stringify(data), {
  expirationTtl: CONFIG.CACHE_TTL.PRODUCTS // 3600 seconds
})

// Frontend: TanStack Query cache
queryClient.setQueryData(['products'], products)
```

---

## 10. Testing & Quality Assurance

### Testing Strategy

```typescript
// Backend: Vitest unit tests
// Location: softcream-api/test/

// Example test structure
describe('orderService', () => {
  it('should calculate prices correctly', async () => {
    const result = await calculateOrderPrices(items, null, env)
    expect(result.total).toBe(expectedTotal)
  })
})
```

### Type Checking

```bash
# Run TypeScript type checker
npm run type-check

# Expected: 0 errors
```

### Linting

```bash
# Run ESLint
npm run lint

# Auto-fix issues
npm run lint:fix
```

### Manual Testing Checklist

- [ ] Order submission flow (delivery + pickup)
- [ ] Coupon validation (parent/child/second use)
- [ ] Cart persistence across page reloads
- [ ] Dark mode toggle
- [ ] RTL layout correctness
- [ ] Mobile responsiveness
- [ ] Admin dashboard functionality
- [ ] Order tracking real-time updates

---

## ğŸ“š Additional Resources

### Documentation Locations

- **Cleanup Guide:** `docs/CLEANUP_NEXT_STEPS.md`
- **Archived Docs:** `docs/archive/` (34 files - reference only)
- **API Documentation:** `softcream-api/src/services/Complete System Documentation - README.md`

### External Dependencies

- [Next.js Docs](https://nextjs.org/docs)
- [Tailwind CSS Docs](https://tailwindcss.com/docs)
- [TanStack Query Docs](https://tanstack.com/query/latest)
- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)

---

## ğŸ¯ Quick Reference Commands

```bash
# Frontend Development
cd soft-cream-nextjs
npm run dev              # Start dev server (localhost:3000)
npm run build            # Production build
npm run type-check       # TypeScript validation
npm run lint             # ESLint check

# Backend Development
cd softcream-api
npm run dev              # Start local worker
npm run deploy           # Deploy to Cloudflare
npm test                 # Run Vitest tests

# Cleanup & Maintenance
# See: docs/CLEANUP_NEXT_STEPS.md for Phase 2-4 tasks
```

---

**Remember:** This codebase is now in its cleanest state. Keep it that way by following these rules strictly. When in doubt, refer to this file first.

**Last Cleanup:** November 19, 2025 - Phase 1 Complete âœ…  
**Last Updated:** November 21, 2025 - Add-ons System & Smart Expansion Added âœ…
